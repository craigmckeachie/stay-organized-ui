<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todos</title>
    <link rel="stylesheet" href="./css/styles.css" />
</head>

<body>
    <header>
        <nav>
            <ul>
                <li><a href="./">Home</a></li>
                <li><a href="./todos.html">Todos</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <h1>Todos</h1>
        <select name="usersDropDownList" id="usersDropDownList">
            <option value="">Select</option>
        </select>
        <button id="addTaskButton">+ Add Task</button>
        <section id="todosList">
        </section>


    </main>
    <footer></footer>
    <script src="./scripts/common.js"></script>
    <script>
        const usersDropDownList = $q("#usersDropDownList");
        const todosList = $q("#todosList");
        const addTaskButton = $q("#addTaskButton");


        function loadTodos(userId) {
            return fetch("http://localhost:8083/api/todos/byuser/" + userId).then(response => response.json());
        }

        function createToDoCard(todo) {
            const cardDiv = document.createElement("div");
            cardDiv.classList.add("card");

            const categoryElement = document.createElement("p");
            const priorityElement = document.createElement("p");
            const descriptionElement = document.createElement("p");
            const deadlineElement = document.createElement("p");

            categoryElement.innerText = todo.category;
            priorityElement.innerText = todo.priority;
            descriptionElement.innerText = todo.description;
            deadlineElement.innerText = todo.deadline;

            cardDiv.append(categoryElement, priorityElement, descriptionElement, deadlineElement);

            return cardDiv;
        }

        function fillTodosList(todos) {
            todosList.innerHTML = "";
            for (const todo of todos) {
                todosList.appendChild(createToDoCard(todo));
            }
        }

        function userSelected() {
            const userId = usersDropDownList.value;
            if (!userId) return;
            loadTodos(userId).then(data => fillTodosList(data))
            window.history.pushState({}, "Todos", './todos.html?userId=' + userId)
        }



        function addTask() {
            if (usersDropDownList.value) {
                window.location.href = "./new_todo.html?userId=" + usersDropDownList.value;
            } else {
                window.location.href = "./new_todo.html";

            }
        }

        window.onload = function () {
            const selectedUserId = getUserId();
            loadUsers().then(data => {
                fillUsersDropDown(data, selectedUserId)
                if (selectedUserId) {
                    userSelected();
                }
            });
            //OR
            //loadUsers().then(fillUsersDropDown);


            usersDropDownList.onchange = userSelected;
            addTaskButton.onclick = addTask;
        }
    </script>
</body>

</html>